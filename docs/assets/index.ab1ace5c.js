var F=Object.defineProperty,P=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable;var k=(e,t,r)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>{for(var r in t||(t={}))O.call(t,r)&&k(e,r,t[r]);if(R)for(var r of R(t))S.call(t,r)&&k(e,r,t[r]);return e},L=(e,t)=>P(e,M(t));var l=(e,t,r)=>(k(e,typeof t!="symbol"?t+"":t,r),r);const X=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}};X();function D(e){return L(I({},e),{angle:0,which:-1,cursor:{x:0,y:0},matrix:new Array(e.size.y).fill(0).map(()=>new Array(e.size.x).fill(-1))})}function E(e){for(;m(e,0,1););Z(e)}function N(e){e.cursor.y+=1;const t=p(e);return e.cursor.y-=1,t}function m(e,t,r){return e.cursor.x+=t,e.cursor.y+=r,p(e)?!0:(e.cursor.x-=t,e.cursor.y-=r,!1)}function C(e){const t=e.cursor.y;for(;m(e,0,1););const r=e.cursor.y;return e.cursor.y=t,r}function Z({pieces:e,which:t,angle:r,cursor:{x:o,y:s},matrix:i}){for(const{x:n,y:h}of e[t].shapes[r])i[h+s][n+o]=t}function T(e,t){const r=e.pieces[e.which].kicks[e.angle],o=t>0?r.right:r.left,{angle:s,cursor:i}=e;e.angle=(e.angle+4+t)%4;for(const{x:n,y:h}of o)if(e.cursor={x:n+i.x,y:h+i.y},p(e))return!0;return e.angle=s,e.cursor=i,!1}function q(e,t){const{cursor:r,which:o,angle:s}=e;e.which=t,e.angle=0;for(const{x:i,y:n}of e.spawns)if(e.cursor={x:i,y:n},p(e))return!0;return e.cursor=r,e.which=o,e.angle=s,!1}function p({pieces:e,which:t,angle:r,size:{x:o,y:s},cursor:{x:i,y:n},matrix:h}){for(const{x:z,y:A}of e[t].shapes[r]){const g=z+i,d=A+n;if(g<0||d<0||g>=o||d>=s||h[d][g]>=0)return!1}return!0}function J(e){const t=[];return e.matrix=e.matrix.map((r,o)=>r.every(s=>s>=0)?(t.push(o),new Array(e.size.x).fill(-1)):r).sort((r,o)=>+o.every(s=>s===-1)-+r.every(s=>s===-1)),t}const f=null;class K{constructor(t,r){l(this,"game");l(this,"keys",{moveLeft:!1,moveRight:!1});l(this,"timers",{fallInterval:f,repeatTimeout:f,repeatInterval:f});l(this,"onMove",()=>{});l(this,"onMoveFail",()=>{});l(this,"moveX",0);this.config=r,this.game=D(t)}fall(){N(this.game)||this.hardDrop(),m(this.game,0,1)}spawn(t=Math.floor(Math.random()*this.game.pieces.length)){return q(this.game,t)}startFall(){this.timers.fallInterval=setInterval(()=>this.fall(),this.config.fallInterval)}stopFall(){clearInterval(this.timers.fallInterval)}setFallInterval(t){this.stopFall(),this.config.fallInterval=t,this.startFall()}move(){!this.moveX||(m(this.game,this.moveX,0)?this.onMove():this.onMoveFail())}clearTimers(){clearTimeout(this.timers.repeatTimeout),clearInterval(this.timers.repeatInterval),this.timers.repeatTimeout=f,this.timers.repeatInterval=f}movePress(t){this.moveX=t,this.move(),this.config.cancelRepeatOnTurn&&this.clearTimers(),!this.timers.repeatInterval&&!this.timers.repeatTimeout&&(this.timers.repeatTimeout=setTimeout(()=>{this.move(),this.timers.repeatInterval=setInterval(()=>{this.move()},this.config.repeatInterval)},this.config.repeatTimeout))}moveLeftPress(){console.log("ok"),!this.keys.moveLeft&&(this.keys.moveLeft=!0,this.movePress(-1))}moveRightPress(){this.keys.moveRight||(this.keys.moveRight=!0,this.movePress(1))}moveRelease(){this.moveX=0,!(this.keys.moveLeft||this.keys.moveRight)&&this.clearTimers()}rotateLeft(){T(this.game,-1)}rotateRight(){T(this.game,1)}moveLeftRelease(){this.keys.moveLeft=!1,this.moveRelease()}moveRightRelease(){this.keys.moveRight=!1,this.moveRelease()}hardDrop(){E(this.game),this.spawn(),J(this.game),this.clearTimers(),this.moveX&&this.movePress(this.moveX)}}const $={shapes:[[{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:2,y:1}],[{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:1,y:2}],[{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:2,y:0}],[{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2}]],kicks:[{left:[{x:0,y:0},{x:-1,y:0},{x:2,y:0},{x:-1,y:2},{x:2,y:-1}],right:[{x:0,y:0},{x:-2,y:0},{x:1,y:0},{x:-2,y:-1},{x:1,y:2}]},{left:[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}],right:[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}]},{left:[{x:0,y:0},{x:1,y:0},{x:-2,y:0},{x:1,y:-2},{x:-2,y:1}],right:[{x:0,y:0},{x:2,y:0},{x:-1,y:0},{x:2,y:1},{x:-1,y:-2}]},{left:[{x:0,y:0},{x:-1,y:0},{x:2,y:0},{x:-1,y:2},{x:2,y:-1}],right:[{x:0,y:0},{x:1,y:0},{x:-2,y:0},{x:1,y:-2},{x:-2,y:1}]}]},u=[{left:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:1,y:-2}],right:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:0,y:-2},{x:-1,y:-2}]},{left:[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}],right:[{x:0,y:0},{x:1,y:0},{x:1,y:-1},{x:0,y:2},{x:1,y:2}]},{left:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:0,y:-2},{x:-1,y:-2}],right:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:1,y:-2}]},{left:[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:2},{x:-1,y:2}],right:[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:2},{x:-1,y:2}]}],W={shapes:[[{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:1}],[{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:1,y:1}],[{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:1,y:-1}],[{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:-1}]],kicks:u},_={shapes:[[{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:1,y:1}],[{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:1,y:-1}],[{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:-1}],[{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:1}]],kicks:u},v=[{x:-1,y:0},{x:0,y:-1},{x:0,y:0},{x:-1,y:-1}],j={shapes:[v,v,v,v],kicks:[{left:[{x:0,y:0}],right:[{x:0,y:0}]},{left:[{x:0,y:0}],right:[{x:0,y:0}]},{left:[{x:0,y:0}],right:[{x:0,y:0}]},{left:[{x:0,y:0}],right:[{x:0,y:0}]}]},B={shapes:[[{x:0,y:1},{x:0,y:0},{x:1,y:0},{x:-1,y:1}],[{x:0,y:-1},{x:0,y:0},{x:1,y:0},{x:1,y:1}],[{x:-1,y:0},{x:0,y:0},{x:0,y:-1},{x:1,y:-1}],[{x:-1,y:0},{x:0,y:0},{x:0,y:1},{x:-1,y:-1}]],kicks:u},G={shapes:[[{x:0,y:1},{x:0,y:0},{x:1,y:0},{x:-1,y:0}],[{x:0,y:-1},{x:0,y:0},{x:1,y:0},{x:0,y:1}],[{x:-1,y:0},{x:0,y:0},{x:0,y:-1},{x:1,y:0}],[{x:-1,y:0},{x:0,y:0},{x:0,y:1},{x:0,y:-1}]],kicks:u},H={shapes:[[{x:0,y:1},{x:0,y:0},{x:1,y:1},{x:-1,y:0}],[{x:1,y:-1},{x:0,y:0},{x:1,y:0},{x:0,y:1}],[{x:-1,y:-1},{x:0,y:0},{x:0,y:-1},{x:1,y:0}],[{x:-1,y:0},{x:0,y:0},{x:-1,y:1},{x:0,y:-1}]],kicks:u},y=new K({size:{x:10,y:21},pieces:[$,_,W,j,B,G,H],spawns:[{x:5,y:1}]},{repeatTimeout:200,repeatInterval:0,softDropMultiplier:1,repeatCutTimeout:1,fallInterval:1500,cancelRepeatOnTurn:!0});y.spawn(0);y.startFall();window.engine=y;const c=document.body.appendChild(document.createElement("canvas"));c.style.border="1px black solid";const x=20;c.width=x*y.game.size.x;c.height=x*y.game.size.y;const a=c.getContext("2d");window.onkeydown=e=>{switch(e.preventDefault(),e.key){case"ArrowLeft":y.moveLeftPress();break;case"ArrowRight":y.moveRightPress();break;case"x":y.rotateLeft();break;case"z":y.rotateRight();break;case" ":y.hardDrop();break}};window.onkeyup=e=>{switch(e.preventDefault(),e.key){case"ArrowLeft":y.moveLeftRelease();break;case"ArrowRight":y.moveRightRelease();break}};const w=(e,t=100)=>`hsl(${e/y.game.pieces.length*360}, ${t}%, 50%)`;function b(){a.clearRect(0,0,c.width,c.height);for(let t=0;t<y.game.size.y;t++)for(let r=0;r<y.game.size.x;r++){const o=y.game.matrix[t][r];o>=0&&(a.fillStyle=w(o),a.fillRect(r*x,t*x,x,x))}const e=C(y.game);for(let{x:t,y:r}of y.game.pieces[y.game.which].shapes[y.game.angle])a.fillStyle=w(y.game.which,10),a.fillRect((t+y.game.cursor.x)*x,(r+e)*x,x,x),a.fillStyle=w(y.game.which),a.fillRect((t+y.game.cursor.x)*x,(r+y.game.cursor.y)*x,x,x);requestAnimationFrame(b)}b();
